<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>{{ case_id }}</title>
    <link rel="stylesheet" href="/static/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/nav.css">
    <link rel="stylesheet" href="/static/css/indexing.css">
    <link rel="stylesheet" href="/static/css/checking.css">
    <link rel="stylesheet" href="/static/css/graph-components.css">
    <link rel="stylesheet" href="/static/css/selectable-header.css">
    <link rel="stylesheet" href="/static/css/graph-detail.css">
    <link rel="stylesheet" href="/static/css/media-resource.css">
    <link rel="stylesheet" href="/static/css/hopping-form.css">
    <link rel="stylesheet" href="/static/lib/input_file/input_file.css">
    <link rel="stylesheet" href="/static/css/tab-text-editor.css">
    <link rel="stylesheet" href="/static/css/bool-list-editor.css">
    <link rel="stylesheet" href="/static/css/switch-btn.css">
    <link rel="stylesheet" href="/static/lib/slide_picture/carousel.css"/>
    {#    <link rel="stylesheet" href="/static/css/universal-album.css"/>#}
    <script src="/static/lib/vue/vue.js"></script>
    <script src="/static/js/vue-components/tab-text-editor.js"></script>
    <script src="/static/js/vue-components/selectable-header.js"></script>
    <script src="/static/js/vue-components/media-resource.js"></script>
    <script src="/static/js/vue-components/file-uploader.js"></script>
    <script src="/static/js/vue-components/album.js"></script>
    <script src="/static/js/vue-components/switch-btn.js"></script>
    {#    <script src="/static/js/vue-components/universal-album.js"></script>#}
    <script src="/static/js/vue-components/bool-list-editor.js"></script>

</head>
<body>
<nav id="nav">
    <button :class="['nav-btn', tab.active?'nav-btn-active':'']" v-for="(tab, idx) in tabs" v-text="tab.name"
            @click="switcher(idx)"></button>

    <button :disabled="!savingCompleted" @click="save" id="save-btn"
            class="glyphicon glyphicon-cloud-upload"></button>
</nav>
<div v-if="show" id="graph-container" class="graph-container" @click="select(0, 0)">
    <!--<div class="graph-mask"></div>-->
    <div v-for="(first, firstLevelIdx) in structure.firstLevelItems"
         class="first-level-container" @click="select(1, firstLevelIdx);">
        <div class="box-arrow graph-item-selectable"
             :class="[ isSelected(firstLevelIdx) ? 'graph-item-selected' : 'graph-item-unselected' ]">
            <div class="box-arrow-text non-selectable" v-text="(firstLevelIdx+1)+'. '+ first.name"></div>
            <div class="box-arrow-bg">
                <div class="box-arrow-bg-top"></div>
                <div class="box-arrow-bg-bottom"></div>
            </div>
        </div>
        <ul v-if="first.expand" class="horizontal-list">
            <li v-for="(second, secondLevelIdx) in first.secondLevelItems">
                <div class='second-level-container' @click="select(2, secondLevelIdx);">
                    <div class="second-level-text graph-item-selectable"
                         :class="[ isSelected(firstLevelIdx, secondLevelIdx) ? 'graph-item-selected' : 'graph-item-unselected']">

                        <div class="second-level-progress">
                            <div v-for="outline in second.outlines" class="outline-bar"></div>
                        </div>
                        <div class="done" :style="{'width': outlineProgress(second.outlines)}"></div>
                        <!-- 二级标题分行 -->
                        <!--
                        <div class="non-selectable"
                             v-text="second.name.substring(0, parseInt(1 + second.name.length)/2)">
                        </div>
                        <div class="non-selectable" v-text="second.name.substring(parseInt(1 + second.name.length)/2)">
                        </div>

                        <div class="non-selectable adaptive-height" v-text="second.name"></div>
                        -->
                        <div class="non-selectable" v-for="line in secondNameLines(second.name)" v-text="line"></div>
                    </div>
                    <ul v-if="second.expand" class="horizontal-list">
                        <li v-for="(third, thirdLevelIdx) in second.thirdLevelItems.filter(_=>_.name!=='其他')"
                            :style="{width: parseInt(100 * third.name.length /
                                    second.thirdLevelItems.map(i => i.name.length).reduce((x1, x2) => x1+x2)) + '%'}">
                            <div class="third-level-container" @click="select(3, thirdLevelIdx)">
                                <div ondblclick="window.location = '#third-level-section'"
                                     class="third-level-text graph-item-selectable"
                                     :class="[isSelected(firstLevelIdx, secondLevelIdx, thirdLevelIdx) ? 'graph-item-selected':'graph-item-unselected' ]">
                                    <!--
                                    <span class="non-selectable" v-for="line3 in thirdNameLines(third.name)" v-text="line3"></span>
                                    -->
                                    <span class="non-selectable" v-text="third.name"></span>
                                </div>
                                <span class="tag" v-if="third.contents.length > 0"
                                      v-text="third.contents.length > 9? '9+' : third.contents.length"></span>
                            </div>
                        </li>
                    </ul>
                </div>
            </li>
        </ul>
    </div>
</div>

<main v-if="show" id="detail">
    <section id="first-level-section">
        <h1>
            <selectable-header v-on:change-candidate="changeCandidate"
                               v-on:step="step"
                               name="first-level-header"
                               :candidates="firstLevel.listNames()"
                               :selected="firstLevel.selectedIdx()"
                               :plain="firstLevel.plain">

            </selectable-header>
        </h1>

        <div class="level-content"
             :class="[firstLevel.plain || firstLevel.selectedIdx !== -1? 'level-content-out':'level-content-in']">
            <div>
                {#                一级标题内容#}
            </div>
        </div>

    </section>

    <div id="editor">
        <section :class="[secondLevel.hide?'hide-l2':'show-l2']" id="second-level-section">
            <h2>
                <selectable-header @change-candidate="changeCandidate" @step="step"
                                   name="second-level-header"
                                   :candidates="secondLevel.listNames()"
                                   :selected="secondLevel.selectedIdx()"
                                   :plain="secondLevel.plain"></selectable-header>
            </h2>
            <hr/>
            <bool-list-editor @change-bool="changeBool"
                              :list="secondLevel.boolOutlines()"></bool-list-editor>
            <tab-text-editor :name-and-contents="secondLevel.textOutlines()"
                             :pointer="secondLevel.pointer"
                             @change-tab="changeTab"></tab-text-editor>

        </section>
        <div id="section-separator" :class="['separator', {'section-closed': secondLevel.hide}]"
             @click="switchSecondLevel">
            <span v-if="!secondLevel.hide" class="glyphicon glyphicon-option-vertical"></span>
            <span v-if="secondLevel.hide" class="l2-char"
                  v-for="char in secondLevel.listNames()[secondLevel.selectedIdx()]" v-text="char"></span>
        </div>
        <section class="" id="third-level-section">
            <h3>
                <selectable-header @change-candidate="changeCandidate" @step="step"
                                   name="third-level-header"
                                   :candidates="thirdLevel.listNames()"
                                   :selected="thirdLevel.selectedIdx()"
                                   :plain="thirdLevel.plain"></selectable-header>
            </h3>
            <hr/>
            <div v-if="thirdLevel.selectedIdx() !== -1">

                <div class="media-source-list">
                    <!-- resource list -->
                    <ul>
                        <li @click="createMedia()">
                            <media-resource class="media-create" type="create" name="新文件"
                                            description=""></media-resource>
                        </li>
                        <li role="separator" style="width: 2em;"></li>
                        <li v-for="(media, i) in (thirdLevel.mediaList() || [])" @click="chooseMedia(i)">
                            <media-resource :type="media.type" :name="media.name"
                                            :description="media.description"
                            ></media-resource>

                        </li>
                    </ul>
                </div>
                <div id="third-level-detail">
                    <!-- 左看 -->
                    <div id="media-previewer"
                         :class="[thirdLevel.previewMedia && parseInt(thirdLevel.mediaPointer)>=0? 'show-media' : 'hide-media']">
                        <video v-if="previewMedia()['type'] === 'video'" :src="previewMedia()['urls'][0]"
                               controls></video>
                        <audio v-if="previewMedia()['type'] === 'audio'" :src="previewMedia()['urls'][0]"
                               controls></audio>
                        <album v-if="previewMedia()['type'] === 'image'" :carousel-list="thirdLevel.carousel"
                               :active="thirdLevel.active" @carousel-move="move" @ocr="ocr"
                               :leave-to-class="thirdLevel.leaveToClass"></album>
                    </div>
                    <div id="media-separator" @click="switchMedia">
                        <div class="glyphicon glyphicon-option-vertical"></div>
                    </div>

                    <!-- 右写 -->
                    <div id="media-editor" class="">

                        <div class="hopping-form">
                            <!--
                            <div class="row hopping-entry">
                                <label for="input-type" class="col-md-2">资源类型</label>
                                <input id="input-type" class="col-md-10" :disabled="detailMedia().type === 'create'" v-model="detailMedia().type">
                            </div>
                            -->
                            <div class="hopping-entry">
                                <label for="input-name">资源名称：</label>
                                <input id="input-name" v-model="detailMedia().name">
                            </div>
                            <div id="media-description" class="hopping-entry">
                                <label for="input-description">资源描述：</label>
                                <textarea id="input-description"
                                          v-model="detailMedia().description"></textarea>
                            </div>
                            <div class="hopping-entry" v-if="thirdLevel.mediaPointer===-1">
                                <label for="file-up-container">选择文件：</label>
                                <div id="file-up-container" class="hopping-input">
                                    <!--
                                        # 规则
                                        在某一次上传时，只可以上传：
                                        一个视频文件，或
                                        一个音频文件，或
                                        多个图片文件
                                    -->

                                    <file-uploader :forbid-upload="thirdLevel.forbidUpload"
                                                   :input-text="thirdLevel.inputText"
                                                   @validate="validateMedia"
                                                   @upload="uploadMedia">
                                    </file-uploader>
                                </div>
                            </div>
                            <div class="hopping-entry" v-if="parseInt(thirdLevel.mediaPointer)>=0">
                                <button class="wide-btn" @click="removeMedia()">删除</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>


</main>

<main v-if="show" id="indexing">
    <aside id="indexing-left">
        <ul>
            <li class="indexing-item">
                <input v-model="newHeaderText" @keyup.enter="newHeader()" title="自定义目录" placeholder="自定义目录">
                {#                <span class="glyphicon glyphicon-ok-circle" @click="newHeader()"></span>#}
                <span class="tail pin glyphicon glyphicon-pushpin" @click="newHeader()"></span>
            </li>
            <li role="separator"></li>
            <li :class="['indexing-item']" v-for="(header, hid) in headers">
                <span v-text="header.name"></span>
                <i class="page-number" v-text="numPage(hid)" @click="locPageByHeader(hid)"></i>
                <span v-if="!header['custom']" class="tail pin glyphicon glyphicon-pushpin"
                      @click="pinPage(hid)"></span>
                <span v-if="header['custom']" class="tail remove glyphicon glyphicon-trash"
                      @click="removePage(hid)"></span>
            </li>
        </ul>
    </aside>
    <div id="indexing-middle">
        <div class="tool-kit">
            <button class="indexing-btn" :disabled="indexingProcessing" @click="autoIndexing()">
                <span>智能编目</span>
                <span :class="['glyphicon', indexingProcessing?'glyphicon-refresh refreshing':'glyphicon-sort-by-order']"></span>
            </button>
            <file-uploader :forbid-upload="forbidUpload"
                           :input-text="uploaderMsg"
                           @validate="validateDocument"
                           @upload="uploadDocument">
            </file-uploader>
            <div>
                <button class="page-btn" @click="goto(-1)">上一页</button>
                <div id="goto-input">
                    <input title="跳转到" ref="goto" @keyup.enter="locPageByInput()" :value="cur + 1" type="number">
                    <span>/</span>
                    <span v-text="imgUrls.length"></span>
                </div>
                <button class="page-btn" @click="goto(1)">下一页</button>
            </div>
            <div>
                <span>批注</span>
                <switch-btn :on="commenting" @switch="switchComment"></switch-btn>
            </div>
        </div>
        <album :active="cur" :urls="imgUrls" :forward="true"
               :boxes="curPageBoxes"
               :active-box-idx="curCommentOnCurPage"
               @draw-box="makeComment"
               :enable-canvas="commenting" @album-move="goto">
        </album>

    </div>
    <aside id="indexing-right">
        <div id="new-comment" :class="[commentMaker.show&&commenting?'show-maker':'hide-maker']">
            <header>添加到事实</header>
            <input placeholder="快速查询" @keyup="queryFacts" title="搜索事实" v-model="factKeywords">
            <ul>
                <li @click="fact.selected = !fact.selected"
                    v-for="fact in factsByKeywords"
                    :class="[fact.selected?'selected':'']">
                    <span v-text="fact.name"></span>
                </li>
                <li @click="fact.selected = !fact.selected"
                    v-for="fact in commentMaker.facts"
                    v-if="factsByKeywords.length === 0"
                    :class="[fact.selected?'selected':'']">
                    <span v-text="fact.name"></span>
                </li>
            </ul>
            <header>简述
            </header>
            <textarea title="description" v-model="commentMaker.description"></textarea>
            <div>
                <button id="accept-comment" @click="acceptComment"
                        :disabled="commentMaker.facts.every(fact=>!fact.selected) && factsByKeywords.every(fact=>!fact.selected)"><span
                        class="glyphicon glyphicon-ok"></span></button>
                <button id="abandon-comment" @click="abandonComment"><span class="glyphicon glyphicon-remove"></span>
                </button>
            </div>
        </div>
        <ul>
            <li v-for="(comment, commentIdx) in curPageComments"
                @click="curCommentOnCurPage=commentIdx"
                :class="['comment-item', commentIdx===curCommentOnCurPage?'active-comment':'']">
                <header>
                    <span class="comment-item-id" v-text="commentIdx+1"></span>
                    <span v-text="comment.factName"></span>
                    <span class="remove glyphicon glyphicon-remove" @click="removeComment(comment)"></span>
                </header>
                <p v-text="comment.description"></p>
            </li>
        </ul>
    </aside>
</main>

<main v-if="show" id="checking">
    <aside id="checking-left">
        <ol>
            <li :class="['checking-item-first', expandFlags[firstIdx]?'expand-sub':'collapse-sub']"
                v-for="(first, firstIdx) in firsts">
                <header v-text="first.name" @click="switchSublist(firstIdx)"></header>
                <ul class="sub-list">
                    <li class="checking-item-second"
                        v-for="(second, secondIdx) in first.secondLevelItems"
                        @click="selectFact(firstIdx, secondIdx)">
                        <header>
                            <span v-text="second.name"></span>
                            <span :class="['item-state', stateStyle(second.state, true)]"></span>
                        </header>
                    </li>
                </ul>
            </li>
        </ol>
    </aside>
    <div id="checking-right" v-if="curFact.name !== ''">
        <h1>
            <small v-text="titles[0]"></small>
            <br/>
            <span v-text="titles[1]"></span>
            <span :class="[stateStyle(curFact.state), 'header-state']" v-text="' '+curFact.state"></span>
        </h1>
        <div class="checking-item-third checking-item-third-header">
            <div class="source"><span>来源</span></div>
            <div class="description"><span>备注</span></div>
            <div class="piece"><span>批注截图</span></div>
        </div>
        <div class="checking-item-third" v-for="(comment, cid) in comments">
            <div class="source">
                <span v-text="comment.evidenceName"></span>
            </div>
            <div class="description">
                <p v-text="comment.description"></p>
            </div>
            <div class="piece">
                <div class="piece-container" :id="'piece-container-'+cid">
                    <!-- img here -->
                </div>
            </div>
        </div>
        <hr/>
        <div id="checking-result">
            <textarea title="理由" placeholder="补充说明理由" v-model="curFact.reason"></textarea>
            <div>
                <button class="checking-accept-btn" @click="pass()">通过</button>
                <button class="checking-reject-btn" @click="reject()">拒绝</button>
                <button class="checking-clear-btn" @click="clear()">清除状态</button>
            </div>
        </div>
    </div>
</main>

<script>
    const caseId = '{{ case_id }}';
    console.log(caseId);
    let selection = [-1, -1, -1];
    let graph = new Vue({
        el: '#graph-container',
        data: {
            selection: selection,
            structure: {},
            show: false
        },

        methods: {
            select: function (level, idx) {
                /*
                * `this.selection`是一个列表，保存当前选择的项目，
                * 值为`-1`表示这一层没有项目被选中
                *
                * > 注意：在选择低层的项目时，会同时选中它所有的父级项目
                * */
                let e = window.event;
                switch (level) {
                    case 3:
                        e['trigger-level'] = 2;
                        e['selection'] = [-1, -1, idx];
                        break;
                    case 2:
                        if (!e['trigger-level']) e['trigger-level'] = 1;
                        if (e['selection']) {
                            e['selection'][1] = idx;
                        } else {
                            e['selection'] = [-1, idx, -1];
                        }
                        break;
                    case 1:
                        if (!e['trigger-level']) e['trigger-level'] = 0;
                        if (e['selection']) {
                            e['selection'][0] = idx;
                        } else {
                            e['selection'] = [idx, -1, -1];
                        }
                        break;
                    case 0:
                        this.selection = e['selection'] || [-1, -1, -1];

                        let triggerLevel = e['trigger-level'];

                        let node = {};
                        if (triggerLevel === 0) {
                            // 点击的是L1元素
                            node = this.structure.firstLevelItems[this.selection[0]];
                        } else if (triggerLevel === 1) {
                            node = this.structure.firstLevelItems[this.selection[0]].secondLevelItems[this.selection[1]];
                        }
                        node.expand = !(node.expand || false);
                    // console.log(this.selection);
                }
            },

            isSelected: function (...idxTree) {
                // `...`称为rest parameters, 传入方法的所有参数将被转为数组存入`idxTree`
                if (idxTree.length === 0 || this.selection.map(_ => _ === -1).reduce((x1, x2) => x1 && x2)) return false;
                for (let i = 0; i < idxTree.length; i++) {
                    if (idxTree[i] !== this.selection[i])
                        return false
                }
                return true;
            },

            updateData: function () {
                const url = `/get-case?case_id=${caseId}`;

                fetch(url).then((response) => {
                    if (response.status !== 200) {
                        console.error("存在一个问题，状态码为：" + response.status);
                        return null;
                    }

                    response.json().then((data) => {
                        console.dir(data);
                        this.structure = data;
                    })
                })
            },

            secondNameLines: function (name) {
                if (name.length < 7) {
                    return [" ", name, " "]
                } else {
                    let p = ((name.length + 2) / 3) ^ 0;
                    return [name.substring(0, p), name.substring(p, p + p), name.substring(p + p)]
                }
            },

            /**
             * not used
             * */
            thirdNameLines: function (name) {
                if (name.length < 4) {
                    return [name];
                } else {
                    let lines = [];
                    let end, start;
                    for (end = 2, start = 0; end < name.length; start += 2, end += 2) {
                        lines.push(name.substring(start, end));
                    }
                    lines.push(name.substring(start));
                    return lines;
                }
            },

            outlineProgress: function (outlines) {
                /**
                 * o.contents can be an `Array` or a `String`
                 */
                if (!outlines) return '0%';
                let ratio = 100 * outlines.filter(o => o.contents.length !== 0).length / outlines.length;
                return ratio + "%";
            }
        },


        created: function () {
            {#this.updateData();#}
        }
    });

    let detail = new Vue({
        el: '#detail',
        data: {
            selection: Array(...selection),
            show: false,
            firstLevel: {
                listNames: function () {
                    if (graph.structure.firstLevelItems)
                        return graph.structure.firstLevelItems.map(i => i['name']);
                    else
                        return [];
                },

                selectedIdx: function () {
                    return graph.selection[0];

                },

                plain: true
            },
            secondLevel: {
                list: function () {
                    let firstIdx = graph.selection[0];
                    if (graph.structure.firstLevelItems
                        && graph.structure.firstLevelItems[firstIdx]
                        && graph.structure.firstLevelItems[firstIdx].secondLevelItems) {
                        return graph.structure.firstLevelItems[firstIdx].secondLevelItems;
                    } else {
                        return [];
                    }
                },
                listNames: function () {
                    return this.list().map(i => i['name']);
                },

                selectedIdx: function () {
                    return graph.selection[1]
                },

                textOutlines: function () {
                    let secondItem = this.list()[this.selectedIdx()];
                    if (secondItem) {
                        let txts = secondItem.outlines.filter(i => i.type !== 'bool');
                        if (txts) {
                            if (this.pointer >= txts.length) this.pointer = 0;

                            return txts;
                        }
                    }

                    this.pointer = -1;
                    return [];
                    /*if (secondItem && secondItem.outlines) {
                        if (this.pointer >= secondItem.outlines.length) this.pointer = 0;
                        return secondItem.outlines
                    } else {
                        this.pointer = -1;
                        return []
                    }*/
                },

                boolOutlines: function () {
                    let secondItem = this.list()[this.selectedIdx()];
                    if (secondItem) {
                        let bools = secondItem.outlines.filter(i => i.type === 'bool');
                        return bools || [];
                    } else {
                        return [];
                    }
                },

                pointer: -1,
                plain: true,
                hide: false
            },
            thirdLevel: {
                listNames: function () {
                    let firstIdx = graph.selection[0];
                    let secondIdx = graph.selection[1];
                    if (graph.structure.firstLevelItems
                        && graph.structure.firstLevelItems[firstIdx]
                        && graph.structure.firstLevelItems[firstIdx].secondLevelItems
                        && graph.structure.firstLevelItems[firstIdx].secondLevelItems[secondIdx]
                        && graph.structure.firstLevelItems[firstIdx].secondLevelItems[secondIdx].thirdLevelItems) {
                        return graph.structure.firstLevelItems[firstIdx].secondLevelItems[secondIdx].thirdLevelItems.map(i => i['name']);
                    } else {
                        return [];
                    }
                },

                selectedIdx: function () {
                    return graph.selection[2]
                },

                plain: true,
                filenameForbidden: /[\\\/*:?'"<>]/,
                forbidUpload: true,
                inputText: '一组图片 或 一个其他类型文件',
                editable: true,
                previewMedia: true,
                mediaList: function () {
                    // 相当于复制了graph.selection
                    const treeIdx = graph.selection;

                    // 如果第三级没有被选中，则‘视听材料’肯定没有被选中，‘视听材料’属于第三级
                    if (treeIdx.filter(_ => _ < 0).length > 0) return false;

                    let l3 = graph.structure.firstLevelItems[treeIdx[0]].secondLevelItems[treeIdx[1]].thirdLevelItems[treeIdx[2]];
                    return l3.contents;
                    /*if (l3.name === '视听材料') {
                        return l3.contents;
                    { else {
                        return false;
                    }*/
                },

                mediaPointer: null, // or -1, 0, 1, 2, ...

                newMedia: {
                    name: '',
                    description: '',
                    type: 'create'
                },
                active: 0,//当前轮播图位置
                carousel: null,//轮播内容
                forward: true,//轮播图片离开时的动画，不同方向，动画不同
            },


        },

        methods: {
            move: function (offset) {//direction为轮播方向，正数为右，负数为左。index为当前轮播图
                let num = this.thirdLevel.active;
                num = num + offset;

                num = num >= this.thirdLevel.carousel.length ? 0 :
                    num < 0 ? this.thirdLevel.carousel.length - 1 : num;

                this.thirdLevel.active = num;

                this.thirdLevel.forward = offset > 0 ? "carousel-animate-leave-to-left" : "carousel-animate-leave-to-right";
            },

            changeCandidate: function (idx, componentName) {
                // console.log(idx + ' ' + componentName);
                if (componentName === 'first-level-header') {
                    graph.selection = [idx, -1, -1]
                } else if (componentName === 'second-level-header') {
                    graph.selection = [graph.selection[0], idx, -1]
                } else if (componentName === 'third-level-header') {
                    graph.selection = [graph.selection[0], graph.selection[1], idx];
                }
                this.thirdLevel.mediaPointer = null;
            },
            step: function (direction, componentName) {
                let level = null;
                if (componentName === 'first-level-header') {
                    level = this.firstLevel;
                } else if (componentName === 'second-level-header') {
                    level = this.secondLevel;
                } else if (componentName === 'third-level-header') {
                    level = this.thirdLevel;
                }

                if (level && level.selectedIdx() !== -1) {
                    let test = level.selectedIdx();
                    let length = level.listNames().length;

                    if (direction === 'left') test--;
                    else if (direction === 'right') test++;

                    if (test >= 0 && test < length) {
                        this.changeCandidate(test, componentName);
                    }
                }
            },
            validateMedia: function (files) {
                // 二进制
                let image = 0b0001;
                let video = 0b0010;
                let audio = 0b0100;
                let other = 0b1000;

                let getMediaTypeBits = (suffix) => {
                    suffix = suffix.toLowerCase();
                    if (suffix === "jpg" || suffix === "png" || suffix === "bmp" || suffix === "svg") {
                        return image;
                    } else if (suffix === "mpeg" || suffix === "avi" || suffix === "mov" || suffix === "asf" || suffix === "rmvb" || suffix === "mpg" || suffix === "mp4") {
                        return video;
                    } else if (suffix === "mp3" || suffix === "midi" || suffix === "wma") {
                        return audio;
                    } else {
                        return other;
                    }
                };

                // 将files转为数组
                let typeBit = new Array(...files).map(fileObj => getMediaTypeBits(fileObj.name.split('.').pop())).reduce((suffix1, suffix2) => suffix1 | suffix2);
                /*
                 * map 将文件数组转为后缀名的二进制表示数组
                 * reduce 的结果是一个数，如果数组中全是图片，则为1；如果既有图片又有视频则为3.
                 * 我们已经规定，如果有多个文件，则它们必须全部是图片类型，所以可以认为任何数组内都是同一类型文件（其他类型文件只能上传一个）
                 * 显然typeBit必须是2的整数幂，判断它是否为2的整数幂
                 */
                let isSingleType = (typeBit & typeBit - 1) === 0;

                if (!isSingleType || (files.length > 1 && typeBit !== image)) {
                    let msg = '除了图片，每次只能上传一个文件';
                    console.error(msg);
                    this.thirdLevel.forbidUpload = true;
                    this.thirdLevel.inputText = '规则验证失败，重新选择';
                } else if (files.length === 0) {
                    let msg = '请选择文件';
                    console.error(msg);
                    this.thirdLevel.forbidUpload = true;
                    this.thirdLevel.inputText = '选择文件';
                    return msg;
                } else {
                    console.log('validation passed');
                    this.thirdLevel.forbidUpload = false;
                    this.thirdLevel.inputText = files.length === 1 ? files[0].name : `选择了${files.length}个文件`;
                    return true;
                }
            },
            removeMedia: function () {
                const url = "/media-remove";
                const filenameForbidden = this.thirdLevel.filenameForbidden;
                let category = [
                    caseId,
                    this.firstLevel.listNames()[this.firstLevel.selectedIdx()],
                    this.secondLevel.listNames()[this.secondLevel.selectedIdx()],
                    this.thirdLevel.listNames()[this.thirdLevel.selectedIdx()],
                    this.thirdLevel.mediaList()[this.thirdLevel.mediaPointer]['name']
                ];

                fetch(url, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        category: category.map(dir => dir.replace(filenameForbidden, '_')).join('/')
                    })
                }).then((res) => {
                    if (res.ok) {
                        res.json().then(j => console.log(`[删除媒体] -> ${JSON.stringify(j)}`));
                        graph.updateData();
                    }
                })
            },
            uploadMedia: function (files) {
                const url = "/media-upload";
                let formData = new FormData();

                files.forEach((temp) => {
                    let filename = temp.name;
                    formData.append(filename, temp);
                });


                const filenameForbidden = this.thirdLevel.filenameForbidden;
                let category = [
                    caseId,
                    this.firstLevel.listNames()[this.firstLevel.selectedIdx()],
                    this.secondLevel.listNames()[this.secondLevel.selectedIdx()],
                    this.thirdLevel.listNames()[this.thirdLevel.selectedIdx()],
                    this.thirdLevel.newMedia.name
                ];
                // formData.append("category", "测试案号123/查找被害人，确认死者身份/死亡时间/视听材料/图片集1");
                // formData.append("description", "这是关于媒体1文件的描述，这个描述可以很长");

                // 如果媒体名称为空，则使用传入的第一个文件名
                if (category[4] === '') category[4] = files[0].name;
                formData.append("category", category.map(dir => dir.replace(filenameForbidden, '_')).join('/'));
                formData.append('description', this.thirdLevel.newMedia.description);


                fetch(url, {
                    method: "post",
                    body: formData
                }).then((response) => {
                    if (response.status !== 200) {
                        console.log("上传失败，状态码为：" + response.status);
                        return;
                    }
                    //检查响应文本
                    response.json().then((data) => {
                        this.thirdLevel.forbidUpload = true;
                        this.thirdLevel.inputText = '一组图片 或 一个其他类型文件';
                        graph.updateData();
                        console.dir(data);
                    });
                }).catch(function (err) {
                    console.error("Fetch错误:" + err);
                });
            },
            chooseMedia: function (idx) {
                this.thirdLevel.mediaPointer = idx;
                // console.dir(this.thirdLevel.mediaList()[idx])
            },
            createMedia: function () {
                console.log('creating');
                this.thirdLevel.mediaPointer = -1;
            },
            detailMedia: function () {
                const ptr = this.thirdLevel.mediaPointer;
                if (ptr === null || this.thirdLevel.mediaList() === false || ptr >= this.thirdLevel.mediaList().length) {
                    this.thirdLevel.mediaPointer = null;
                    return {
                        name: '',
                        description: '',
                        type: ''
                    }
                } else if (ptr === -1) {
                    // console.log('point to new');
                    return this.thirdLevel.newMedia;
                } else {
                    // console.log(`point to ${ptr}`);
                    return this.thirdLevel.mediaList()[ptr]
                }
            },
            previewMedia: function () {
                if (this.thirdLevel.mediaList() === false || this.thirdLevel.mediaPointer >= this.thirdLevel.mediaList().length) {
                    this.thirdLevel.mediaPointer = null;
                }
                const ptr = this.thirdLevel.mediaPointer;
                if (ptr !== null && ptr !== -1) {
                    // 当前L3元素指向改变时，ptr可能仍然是旧的值
                    let media = this.thirdLevel.mediaList()[ptr];// || {urls: [], type: false};
                    if (media.type === 'image') {
                        this.thirdLevel.carousel = media.urls;
                        let images = [];
                        for (let i = 0; i < this.thirdLevel.carousel.length; i++) {//预加载图片
                            images[i] = new Image();
                            images[i].src = this.thirdLevel.carousel[i];
                        }
                    }
                    return {
                        urls: media.urls,
                        type: media.type
                    }
                } else {
                    return {urls: '', type: false}
                }
            },

            ocr: function (staticPath) {
                console.info(staticPath);
                fetch('/ocr', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        staticPath: staticPath
                    })
                }).then((res) => {
                    console.log('ocr return');
                    if (res.ok) {
                        res.json().then(j => {
                            console.info(j['result']);
                            this.detailMedia().description += '\n\n' + j['msg'];
                        })
                    }
                })
            },

            switchMedia: function () {
                this.thirdLevel.previewMedia = !this.thirdLevel.previewMedia
            },

            switchSecondLevel: function () {
                this.secondLevel.hide = !this.secondLevel.hide;
            },

            changeTab: function (i) {
                this.secondLevel.pointer = i;
            },

            changeBool: function (i) {
                let boolItem = this.secondLevel.boolOutlines()[i];
                boolItem.contents = boolItem.contents === '是' ? '否' : '是';
            },

            l1Update: function () {

            },
            l2Update: function () {
                this.changeTab(this.secondLevel.textOutlines().length > 0 ? 0 : -1);
            },
            l3Update: function () {
                this.thirdLevel.mediaPointer = null;
            }
        },

        beforeUpdate: function () {
            let gs = graph.selection;
            let ds = this.selection;

            if (gs[0] !== ds[0]) {
                // console.info('update'+' 1,2,3');
                this.l1Update();
                this.l2Update();
                this.l3Update();
            } else if (gs[1] !== ds[1]) {
                // console.info('update'+' 2,3');
                this.l1Update();
                this.l2Update();
            } else if (gs[2] !== ds[2]) {
                // console.info('update'+' 3');
                this.l3Update();
            }
            this.selection = graph.selection;
        }

    });

    let indexing = new Vue({
        el: "#indexing",
        data: {
            show: false,
            indexingProcessing: false,
            headers: [],
            newHeaderText: '',

            uploaderMsg: '上传卷宗图片',
            forbidUpload: true,

            imgUrls: [],
            imgHeaderTexts: [],
            headerScores: [],
            cur: -1,
            comments: [],
            commenting: false,
            curCommentOnCurPage: -1,
            curPageBoxes: [],
            curPageComments: [],
            commentMaker: {
                show: false,
                facts: [],
                description: '',
                evidenceName: '',
                location: {
                    page: -1,
                    box: [0, 0, 0, 0]
                },
            },
            factKeywords: '',
            factsByKeywords: [],

        },
        methods: {
            getHeaders: function () {
                const url = `/get-headers?case_id=${caseId}`;
                fetch(url, {
                    method: 'get'
                }).then(res => res.json()).then(headers => {
                    this.headers = headers;
                });
            },

            sortHeaders: function () {
                this.headers.sort((h1, h2) => {
                    let p1 = h1.start === null ? Infinity : parseInt(h1.start);
                    let p2 = h2.start === null ? Infinity : parseInt(h2.start);
                    return p1 - p2;
                })
            },

            getFactsByEvidence: function (evidenceName) {
                if (evidenceName === undefined || evidenceName === null) return [];
                let facts = [];
                let struct = graph.structure;
                struct.firstLevelItems.forEach(first => {
                    first.secondLevelItems.forEach(second => {
                        let match = second.thirdLevelItems.some(third => third.name === evidenceName);
                        if (match) facts.push(second.name);
                    })
                });
                return facts;
            },

            initCommentMaker: function (show) {
                this.commentMaker.facts = [];
                this.commentMaker.show = show;
                this.commentMaker.description = '';
                this.commentMaker.evidenceName = '';
                this.commentMaker.location = {
                    page: -1,
                    box: [0, 0, 0, 0]
                }
            },
            makeComment: function (x1, y1, x2, y2) {
                console.log('ocr comment');
                if (x1 === x2 || y1 === y2) return;

                // todo this.boxes[this.cur].push([x1, y1, x2, y2]);
                this.initCommentMaker(true);
                this.commentMaker.location = {page: this.cur, box: [x1, y1, x2, y2]};
                fetch('/ocr', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        imgs: [{
                            path: '.' + this.imgUrls[this.cur],
                            x1: x1,
                            y1: y1,
                            x2: x2,
                            y2: y2
                        }]
                    })
                }).then(res => {
                    if (res.ok) {
                        res.json().then(results => {
                            let result = results[0];
                            if (result === false) return;
                            this.commentMaker.description += '\n' + results[0].replace('\n', '');
                        })
                    }
                });
                if (this.cur < 0 || this.cur > this.imgUrls.length) return [];
                let evidenceName = null;
                for (let i = 0; i < this.headers.length; i++) {
                    let header = this.headers[i];
                    if (header.start === null || header.start > this.cur) {
                        evidenceName = i === 0 ? null : this.headers[i - 1].name;
                        break;
                    }
                }
                this.commentMaker.evidenceName = evidenceName;
                this.commentMaker.facts = this.getFactsByEvidence(evidenceName).map(name => {
                    return {name: name, selected: false}
                });
            },

            acceptComment: function () {
                // 选择的事实
                let selectedFacts = this.commentMaker.facts
                    .concat(this.factsByKeywords)
                    .filter(fact => fact.selected);
                graph.structure.firstLevelItems.forEach(first => {
                    first.secondLevelItems.forEach(second => {
                        for (let i = 0; i < selectedFacts.length; i++) {
                            let fact = selectedFacts[i];

                            // 找到了对应事实
                            if (second['name'] === fact['name']) {
                                // 对应事实下的证据
                                let targetThird = second.thirdLevelItems.find(third => third['name'] === this.commentMaker.evidenceName);
                                if (targetThird === undefined) {
                                    second.thirdLevelItems.push({
                                        name: '其他',
                                        contents: []
                                    });
                                    targetThird = second.thirdLevelItems.find(third => third['name'] === '其他');
                                }
                                targetThird.contents.unshift({
                                    page: this.commentMaker['location']['page'],
                                    box: this.commentMaker['location']['box'],
                                    description: this.commentMaker['description']
                                })

                            }
                        }
                    })
                });
                console.log('refreshing comment list...');
                this.initCommentMaker(false);
                this.listComment();
            },

            removeComment: function (comment) {
                let node = graph.structure.firstLevelItems.find(first => first['name'] === comment.nodeName);
                // debugger;
                if (node) {
                    let fact = node.secondLevelItems.find(second => second['name'] === comment.factName);
                    // debugger;
                    if (fact) {
                        let evidence = fact.thirdLevelItems.find(third => third['name'] === comment.evidenceName);
                        if (!evidence) evidence = fact.thirdLevelItems.find(third => third['name'] === '其他')
                        // debugger;
                        if (evidence) {
                            for (let i = 0; i < evidence.contents.length; i++) {
                                let piece = evidence.contents[i];
                                if (piece['page'] === comment['page']
                                    && piece['description'] === comment['description']
                                // && JSON.stringify(piece['box']) === JSON.stringify(comment['box'])
                                ) {

                                    evidence.contents.splice(i, 1);
                                    this.listComment();
                                    console.log('piece removed');
                                    break;
                                }
                            }
                        }
                    }
                }
            },

            listComment: function () {
                let comments = [];
                graph.structure.firstLevelItems.forEach(first => {
                    first.secondLevelItems.forEach(second => {
                        second.thirdLevelItems.forEach(third => {
                            third.contents.forEach(item => {
                                comments.push({
                                    page: item['page'],
                                    box: item['box'],
                                    description: item['description'],
                                    evidenceName: third['name'],
                                    factName: second['name'],
                                    nodeName: first['name']
                                })
                            })
                        })
                    })
                });
                this.comments = comments;
                this.refreshCurPageComments();
                console.log('comment list refreshed')
            },

            queryFacts: function () {
                this.factsByKeywords = [];
                if (this.factKeywords !== '') {
                    graph.structure.firstLevelItems.forEach(first => {
                        first.secondLevelItems.forEach(second => {
                            if (second.name.search(this.factKeywords) >= 0) {
                                this.factsByKeywords.push({
                                    name: second.name,
                                    selected: false
                                });
                            }
                        })
                    });
                }
            },

            refreshCurPageComments: function () {
                this.curPageComments = this.comments.filter(c => c['page'] === this.cur);
                this.curPageBoxes = this.curPageComments.map(c => c['box']);

            },
            abandonComment: function () {
                this.commentMaker.show = false;
            },

            validateDocument: function (files) {
                let fileList = new Array(...files);
                let illegalSuffix = true;
                if (fileList.length === 1) {
                    let suffix = fileList[0].name.split('.').pop().toLowerCase();
                    if (suffix === 'png' || suffix === 'jpg' || suffix === 'jpeg' || suffix === 'pdf') {
                        illegalSuffix = [];
                    }
                } else {
                    illegalSuffix = fileList.map(file => file.name.split('.').pop()).filter(suffix => {
                        suffix = suffix.toLowerCase();
                        return suffix !== 'png' && suffix !== 'jpg' && suffix !== 'jpeg'
                    });
                }
                this.forbidUpload = illegalSuffix.length !== 0;
                this.uploaderMsg = this.forbidUpload ? `存在无效的格式：${illegalSuffix[0]}` : `已选择 ${files.length} 张图片`;
                return !this.forbidUpload;
            },

            uploadDocument: function (files) {
                this.forbidUpload = true;
                const url = "/upload-document";
                let formData = new FormData();

                formData.append('case_id', caseId);
                files.forEach((temp) => {
                    formData.append(temp.name, temp);
                });

                fetch(url, {
                    method: "post",
                    body: formData
                }).then(res => {
                    if (res.ok) {
                        this.getDocumentUrls();
                        res.json().then(paths => {
                            // ocr
                            this.autoIndexing(paths);
                        });
                    }
                    this.forbidUpload = false;
                    this.uploaderMsg = '上传卷宗图片';
                })
            },
            matchIndexing: function (pred, trgt) {

            },
            autoIndexing: function () {
                console.info('auto indexing...');
                this.indexingProcessing = true;
                fetch('/ocr-indexing', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        imgs: this.imgUrls.map(url => {
                            return {
                                path: '.' + url,
                                // 有些图片有边框，会影响分行
                                x1: 0.1,
                                y1: 0.08,
                                x2: 0.9,
                                // 框选部分的大小会影响OTSU判断，所以范围尽量大一些
                                y2: .4,
                            }
                        }),
                        case_id: caseId
                    })
                }).then(res => {
                    if (res.ok) {
                        res.json().then(j => {
                            this.imgHeaderTexts = j['texts'];
                            this.headers = j['headers'].map(_ => {
                                return {
                                    name: _['name'],
                                    start: _['start'],
                                    // todo 去除score
                                    score: _['score']
                                }
                            });
                            this.headerScores = j['headers'].map(_ => _['score'])
                            {#console.log(this.headers);#}
                            {#console.log(this.imgHeaderTexts);#}
                            this.sortHeaders();
                        })

                    }
                    this.indexingProcessing = false;
                })
            },

            getDocumentUrls: function () {
                const url = `/get-document?case_id=${caseId}`;
                fetch(url, {
                    method: 'get'
                }).then(res => {
                    if (res.ok) {
                        res.json().then(j => {
                            this.imgUrls = j;
                            this.boxes = new Array(this.imgUrls.length).fill(new Array(...[]));
                            this.cur = this.imgUrls.length > 0 ? 0 : -1;
                        })
                    }
                })
            },

            switchComment: function () {
                this.commenting = !this.commenting;
            },

            goto: function (offset) {
                let size = this.imgUrls.length;
                if (size === 0) return;
                let ptr = this.cur + offset;
                if (ptr < 0) ptr += size;
                ptr %= size;
                this.cur = ptr;
                this.initCommentMaker(false);
                this.refreshCurPageComments();
            },

            pinPage: function (headerIdx) {
                this.headers[headerIdx].start = this.cur;
                this.sortHeaders();
            },

            removePage: function (headerIdx) {
                this.headers.splice(headerIdx, 1),
                    this.sortHeaders();
            },

            newHeader: function () {
                if (this.newHeaderText === '') return;
                this.headers.push({
                    name: this.newHeaderText,
                    start: this.cur,
                    custom: true
                });
                this.newHeaderText = '';
                this.sortHeaders();
            },

            locPageByHeader: function (headerIdx) {
                let start = this.headers[headerIdx]['start'];
                if (start !== null && start >= 0 && start < this.imgUrls.length) {
                    this.cur = start;
                }
                this.initCommentMaker(false);
                this.refreshCurPageComments();
            },

            locPageByInput: function () {
                let start = parseInt(this.$refs.goto.value) - 1;
                if (start >= 0 && start < this.imgUrls.length) {
                    this.cur = start;
                }
                this.initCommentMaker(false);
                this.refreshCurPageComments();
            },

            numPage: function (headerIdx) {
                let start = this.headers[headerIdx]['start'];
                if (start === null) {
                    return '';
                } else {
                    return start + 1;
                }
            }

        },
        mounted: function () {
            this.getHeaders();
            this.getDocumentUrls();
        }
    });

    let checking = new Vue({
        el: "#checking",
        data: {
            show: false,
            firsts: [],
            expandFlags: [],
            comments: [],

            titles: ['', ''],

            curFact: {
                name: '',
                state: '',
                reason: ''
            },
        },
        methods: {
            refreshData: function () {
                this.firsts = graph.structure.firstLevelItems;
                this.expandFlags = this.firsts.map(_ => true);
                this.firsts.forEach(first => {
                    first.secondLevelItems.forEach(second => {
                        if (second['state'] === undefined) {
                            second['state'] = '未决'
                        }
                        if (second['reason'] === undefined) {
                            second['reason'] = ''
                        }
                    })
                })
            },
            stateStyle: function (state, withIcon) {
                let classes = [];
                if(state === '通过'){
                    classes = ['pass-state', 'glyphicon', 'glyphicon-ok'];
                }else if(state === '不通过'){
                    classes = ['reject-state', 'glyphicon', 'glyphicon-remove'];
                }else{
                    classes = [''];
                }
                if(withIcon){
                    return classes.join(' ');
                }else{
                    return classes.shift();
                }
            },
            switchSublist: function (firstIdx) {
                this.$set(this.expandFlags, firstIdx, !this.expandFlags[firstIdx]);
            },
            selectFact: function (fid, sid) {
                this.titles = [this.firsts[fid].name, this.firsts[fid].secondLevelItems[sid].name];
                let second = graph.structure.firstLevelItems[fid].secondLevelItems[sid];
                this.curFact = second;
                let comments = [];
                second.thirdLevelItems.forEach(third => {
                    third.contents.forEach(content => {
                        comments.push({
                            page: content['page'],
                            imgUrl: indexing.imgUrls[content['page']] || '',
                            box: content['box'],
                            description: content['description'],
                            evidenceName: third['name']
                        })
                    })
                });
                this.comments = comments;
                console.log(this.comments);
                this.$nextTick(() => {
                    setTimeout(this.drawPiece(comments), 0);
                });
            },
            /* DEPRECATED! */
            drawPieceOnCanvas: function (comments) {
                comments.forEach((comment, cid) => {
                    let url = comment['imgUrl'],
                        box = comment['box'],
                        canvas = document.getElementById('canvas-' + cid);
                    console.log(canvas);
                    if (canvas === null) return;
                    let ctx = canvas.getContext('2d');
                    if (!ctx) return;

                    let img = new Image();
                    img.src = url;
                    img.onload = () => {
                        let naturalWidth = img.naturalWidth,
                            naturalHeight = img.naturalHeight;

                        let x1 = box[0] * naturalWidth,
                            y1 = box[1] * naturalHeight,
                            x2 = box[2] * naturalWidth,
                            y2 = box[3] * naturalHeight;
                        let pieceNaturalWidth = x2 - x1,
                            pieceNaturalHeight = y2 - y1;
                        // canvas.height = canvas.offsetWidth * pieceNaturalHeight / pieceNaturalWidth;
                        let canvasWidth = canvas.offsetWidth,
                            canvasHeight = canvas.offsetHeight;
                        /*
                        let pieceWH = pieceNaturalWidth / pieceNaturalHeight,
                            canvasWH = canvasWidth / canvasHeight;
                        let targetWidth = 0,
                            targetHeight = 0;
                        if(pieceWH > canvasWH){
                            // 进行上下填充
                            targetHeight = pieceNaturalWidth / canvasWH;
                            targetWidth = pieceNaturalWidth
                        }else{
                            targetHeight = pieceNaturalHeight;
                            targetWidth = pieceNaturalHeight * canvasWH;
                        }

                        ctx.drawImage(img, x1, y1, targetWidth*2, targetHeight, 0, 0, canvasWidth, canvasHeight)
                        */
                        let wRate = canvasWidth / pieceNaturalWidth,
                            hRate = canvasHeight / pieceNaturalHeight;

                        let rate = 1;
                        if (wRate > 1 && hRate > 1) {
                            rate = Math.min(wRate, hRate);
                        } else if (wRate < 1 && hRate > 1) {
                            rate = wRate;
                        } else if (wRate > 1 && hRate < 1) {
                            rate = hRate;
                        } else if (wRate < 1 && hRate < 1) {
                            rate = Math.min(wRate, hRate)
                        }
                        debugger;
                        console.log(box);
                        console.log(x1, y1, x2, y2);
                        console.log(pieceNaturalWidth, pieceNaturalHeight);
                        console.log(pieceNaturalWidth * rate, pieceNaturalHeight * rate);
                        ctx.drawImage(img,
                            //x1, y1,
                            0, 0,
                            //naturalWidth, naturalHeight,
                            //pieceNaturalWidth, pieceNaturalHeight,
                            //0, 0,
                            canvasWidth, canvasHeight
                            //pieceNaturalWidth * rate, pieceNaturalHeight * rate
                        )
                    };

                })
            },
            drawPiece: function (comments) {
                comments.forEach((comment, cid) => {
                    let url = comment['imgUrl'],
                        box = comment['box'],
                        container = document.querySelector(`#piece-container-${cid}`);
                    if (!container) {
                        console.info('no container found');
                        return;
                    }
                    let img = new Image();
                    img.src = url;
                    console.log('loading img');
                    img.onload = () => {
                        // 图片加载完毕回调,
                        let naturalWidth = img.naturalWidth,
                            naturalHeight = img.naturalHeight;

                        let x1 = box[0] * naturalWidth,
                            y1 = box[1] * naturalHeight,
                            x2 = box[2] * naturalWidth,
                            y2 = box[3] * naturalHeight;
                        let pieceNaturalWidth = x2 - x1,
                            pieceNaturalHeight = y2 - y1;
                        let containerWidth = container.offsetWidth;
                        let rate = containerWidth / pieceNaturalWidth;
                        let resizedWidth = naturalWidth * rate,
                            resizedHeight = naturalHeight * rate;
                        img.style.width = `${resizedWidth ^ 0}px`;
                        img.style.height = `${resizedHeight ^ 0}px`;
                        let pieceResizedWidth = containerWidth,
                            pieceResizedHeight = pieceNaturalHeight * rate;
                        img.style.top = `-${y1 * rate ^ 0}px`;
                        img.style.left = `-${x1 * rate ^ 0}px`;
                        container.style.height = `${pieceResizedHeight ^ 0}px`;
                        container.appendChild(img);

                    }
                })
            },
            pass: function () {
                this.curFact.state = '通过';
                this.refreshData();
            },
            reject: function () {
                this.curFact.state = '不通过';
                this.refreshData();
            },
            clear: function () {
                this.curFact.state = '未决';
                this.refreshData();
            }
        }
    });

    let nav = new Vue({
        el: "#nav",
        data: {
            show: false,
            savingCompleted: true,

            tabs: [
                {
                    name: "卷宗批注",
                    active: false,
                    cons: [indexing]
                },
                {
                    name: "检查事实",
                    active: true,
                    cons: [checking]
                }
            ]
        },
        methods: {
            switcher: function (tabIdx) {
                this.tabs.forEach((tab, idx) => {
                    tab.active = tabIdx === idx;
                    tab.cons.forEach(con => {
                        con.show = tabIdx === idx;
                    })
                })
            },

            save: function () {
                console.info('saving...');
                this.savingCompleted = false;
                let url = "/update-case";
                let case_data = graph.structure;
                case_data['headers'] = indexing.headers;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        case_data: case_data
                    })
                }).then((res) => {
                    if (res.ok) {
                        //graph.updateData();
                        res.json().then(j => {
                            console.info(`[保存案件] -> ${JSON.stringify(j)}`);
                        })
                    } else {
                        console.log("更新失败")
                    }
                    this.savingCompleted = true;
                });
            },
        },
        mounted: function () {
            const url = `/get-case?case_id=${caseId}`;

            fetch(url).then((response) => {
                if (response.ok) {
                    response.json().then(j => {
                        console.log('nav init...');
                        graph.structure = j;
                        console.log(graph.structure);
                        indexing.listComment();
                        console.log(indexing.comments);
                        checking.refreshData();
                    })
                }

            })
        }
    });
    nav.switcher(1);

    window.onscroll = function () {
        if (!graph.show) return;
        let y = window.scrollY;
        let graphHeight = document.getElementById('graph-container').offsetHeight;
        if (y > graphHeight / 2) {
            detail.firstLevel.plain = false;
            detail.secondLevel.plain = false;
            detail.thirdLevel.plain = false;
        } else {
            detail.firstLevel.plain = true;
            detail.secondLevel.plain = true;
            detail.thirdLevel.plain = true;
        }
    }
</script>


</body>
</html>